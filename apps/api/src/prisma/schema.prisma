generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Users ───────────────────────────────────────────────
model User {
  id              String   @id @default(uuid())
  discordId       String   @unique
  discordUsername  String
  discordAvatar   String?
  role            Role     @default(OWNER)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  ownedTeams       Team[]
  submittedResults Result[]      @relation("SubmittedBy")
  disputedResults  Result[]      @relation("DisputedBy")
  resolvedResults  Result[]      @relation("ResolvedBy")
  approvedTrades   TradeOffer[]  @relation("ApprovedBy")
  executedTransactions Transaction[] @relation("ExecutedBy")
}

enum Role {
  ADMIN
  OWNER
}

// ─── Teams ───────────────────────────────────────────────
model Team {
  id        String   @id @default(uuid())
  name      String   @unique
  logoUrl   String?
  ownerId   String
  budget    Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  owner              User                @relation(fields: [ownerId], references: [id])
  competitionTeams   CompetitionTeam[]
  homeMatches        Match[]             @relation("HomeTeam")
  awayMatches        Match[]             @relation("AwayTeam")
  players            Player[]
  initiatedTrades    TradeOffer[]        @relation("InitiatingTeam")
  receivedTrades     TradeOffer[]        @relation("ReceivingTeam")
  waiverBids         WaiverBid[]
  releasedWaivers    WaiverWire[]
  transactionsFrom   Transaction[]       @relation("FromTeam")
  transactionsTo     Transaction[]       @relation("ToTeam")
  items              TeamItem[]
  itemUsageLogs      ItemUsageLog[]
  lineupEntries      MatchLineupEntry[]
  matchSubstitutions MatchSubstitution[]
}

// ─── Competitions ────────────────────────────────────────
model Competition {
  id        String            @id @default(uuid())
  name      String
  type      CompetitionType
  status    CompetitionStatus @default(DRAFT)
  config    Json?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  teams  CompetitionTeam[]
  rounds Round[]
}

enum CompetitionType {
  DOUBLE_ROUND_ROBIN
  SINGLE_ROUND_ROBIN
  KNOCKOUT_CUP
  PLAYOFF
}

enum CompetitionStatus {
  DRAFT
  ACTIVE
  COMPLETED
}

// ─── Junction: Competition <-> Team ──────────────────────
model CompetitionTeam {
  id            String @id @default(uuid())
  competitionId String
  teamId        String
  seed          Int?

  competition Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  team        Team        @relation(fields: [teamId], references: [id])

  @@unique([competitionId, teamId])
}

// ─── Rounds ──────────────────────────────────────────────
model Round {
  id            String   @id @default(uuid())
  competitionId String
  roundNumber   Int
  name          String?
  createdAt     DateTime @default(now())

  competition Competition @relation(fields: [competitionId], references: [id], onDelete: Cascade)
  matches     Match[]

  @@unique([competitionId, roundNumber])
}

// ─── Matches ─────────────────────────────────────────────
model Match {
  id          String      @id @default(uuid())
  roundId     String
  homeTeamId  String
  awayTeamId  String
  matchNumber Int?
  scheduledAt DateTime?
  status      MatchStatus @default(SCHEDULED)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  round         Round                @relation(fields: [roundId], references: [id], onDelete: Cascade)
  homeTeam      Team                 @relation("HomeTeam", fields: [homeTeamId], references: [id])
  awayTeam      Team                 @relation("AwayTeam", fields: [awayTeamId], references: [id])
  result        Result?
  lineupEntries MatchLineupEntry[]
  substitutions MatchSubstitution[]
  playerStats   MatchPlayerStat[]
}

enum MatchStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

// ─── Results ─────────────────────────────────────────────
model Result {
  id             String       @id @default(uuid())
  matchId        String       @unique
  homeScore      Int
  awayScore      Int
  status         ResultStatus @default(PENDING)
  submittedById  String
  disputedById   String?
  resolvedById   String?
  disputeReason  String?
  resolutionNote String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  match       Match @relation(fields: [matchId], references: [id], onDelete: Cascade)
  submittedBy User  @relation("SubmittedBy", fields: [submittedById], references: [id])
  disputedBy  User? @relation("DisputedBy", fields: [disputedById], references: [id])
  resolvedBy  User? @relation("ResolvedBy", fields: [resolvedById], references: [id])
}

enum ResultStatus {
  PENDING
  CONFIRMED
  DISPUTED
  RESOLVED
}

// ─── Match Stats ────────────────────────────────────────
model MatchLineupEntry {
  id        String    @id @default(uuid())
  matchId   String
  teamId    String
  playerId  String
  position  Position
  isStarter Boolean   @default(true)

  match  Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  team   Team   @relation(fields: [teamId], references: [id])
  player Player @relation(fields: [playerId], references: [id])

  @@unique([matchId, teamId, playerId])
}

model MatchSubstitution {
  id          String @id @default(uuid())
  matchId     String
  teamId      String
  playerInId  String
  playerOutId String
  minute      Int

  match     Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  team      Team   @relation(fields: [teamId], references: [id])
  playerIn  Player @relation("SubbedIn", fields: [playerInId], references: [id])
  playerOut Player @relation("SubbedOut", fields: [playerOutId], references: [id])

  @@index([matchId])
}

model MatchPlayerStat {
  id       String         @id @default(uuid())
  matchId  String
  playerId String
  statType MatchStatType
  value    Int            @default(1)
  minute   Int?

  match  Match  @relation(fields: [matchId], references: [id], onDelete: Cascade)
  player Player @relation(fields: [playerId], references: [id])

  @@index([matchId])
  @@index([playerId])
}

enum MatchStatType {
  GOAL
  ASSIST
  TACKLE
  SAVE
}

// ─── Player Enums ───────────────────────────────────────
enum Position {
  GK
  RB
  CB
  LB
  CDM
  CM
  CAM
  RM
  LM
  RW
  LW
  CF
  ST
}

enum RoleLevel {
  BASIC
  INTERMEDIATE
  ADVANCED
}

enum PlayStyleLevel {
  BASIC
  ADVANCED
}

// ─── Item Enums ─────────────────────────────────────────
enum ItemEffectType {
  BOOST_OVERALL
  BOOST_WEAK_FOOT
  BOOST_POTENTIAL
  SET_OVERALL
}

// ─── Transaction Enums ──────────────────────────────────
enum TradeOfferStatus {
  PENDING
  PENDING_APPROVAL
  REJECTED
  COUNTERED
  APPROVED
  DENIED
  CANCELLED
  EXPIRED
}

enum WaiverStatus {
  ACTIVE
  CLAIMED
  CLEARED
  CANCELLED
}

enum TransactionType {
  TRADE
  FREE_AGENCY
  WAIVER_CLAIM
  RELEASED
  WAIVER_CLEAR
  ADMIN_ASSIGN
  ADMIN_RELEASE
}

// ─── Skill Groups & Definitions ─────────────────────────
model SkillGroup {
  id        String   @id @default(uuid())
  name      String   @unique
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  skills SkillDefinition[]
}

model SkillDefinition {
  id           String   @id @default(uuid())
  name         String   @unique
  skillGroupId String
  defaultValue Int      @default(50)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  skillGroup   SkillGroup    @relation(fields: [skillGroupId], references: [id], onDelete: Cascade)
  playerSkills PlayerSkill[]
}

// ─── Player Role & Play Style Definitions ───────────────
model PlayerRoleDefinition {
  id          String   @id @default(uuid())
  name        String
  position    Position
  description String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignments PlayerRoleAssignment[]

  @@unique([name, position])
}

model PlayStyleDefinition {
  id          String   @id @default(uuid())
  name        String
  position    Position
  iconUrl     String?
  description String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignments PlayerPlayStyleAssignment[]

  @@unique([name, position])
}

// ─── Players ────────────────────────────────────────────
model Player {
  id              String   @id @default(uuid())
  firstName       String
  lastName        String
  age             Int
  primaryPosition Position
  overall         Int      @default(50)
  weakFoot        Int      @default(3)
  potential       Int      @default(50)
  teamId          String?
  imageUrl        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  team             Team?                       @relation(fields: [teamId], references: [id], onDelete: SetNull)
  skills           PlayerSkill[]
  positions        PlayerPosition[]
  playStyles       PlayerPlayStyleAssignment[]
  tradePlayers     TradeOfferPlayer[]
  waiverWires      WaiverWire[]
  transactions     Transaction[]
  itemUsages       ItemUsageLog[]
  lineupEntries    MatchLineupEntry[]
  substitutionsIn  MatchSubstitution[]         @relation("SubbedIn")
  substitutionsOut MatchSubstitution[]         @relation("SubbedOut")
  matchStats       MatchPlayerStat[]
}

model PlayerPosition {
  id        String   @id @default(uuid())
  playerId  String
  position  Position
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  player Player               @relation(fields: [playerId], references: [id], onDelete: Cascade)
  roles  PlayerRoleAssignment[]

  @@unique([playerId, position])
}

model PlayerSkill {
  id                String @id @default(uuid())
  playerId          String
  skillDefinitionId String
  value             Int

  player          Player          @relation(fields: [playerId], references: [id], onDelete: Cascade)
  skillDefinition SkillDefinition @relation(fields: [skillDefinitionId], references: [id], onDelete: Cascade)

  @@unique([playerId, skillDefinitionId])
}

model PlayerRoleAssignment {
  id                     String    @id @default(uuid())
  playerPositionId       String
  playerRoleDefinitionId String
  level                  RoleLevel

  playerPosition PlayerPosition       @relation(fields: [playerPositionId], references: [id], onDelete: Cascade)
  roleDefinition PlayerRoleDefinition @relation(fields: [playerRoleDefinitionId], references: [id], onDelete: Cascade)

  @@unique([playerPositionId, playerRoleDefinitionId])
}

model PlayerPlayStyleAssignment {
  id                    String         @id @default(uuid())
  playerId              String
  playStyleDefinitionId String
  level                 PlayStyleLevel

  player              Player              @relation(fields: [playerId], references: [id], onDelete: Cascade)
  playStyleDefinition PlayStyleDefinition @relation(fields: [playStyleDefinitionId], references: [id], onDelete: Cascade)

  @@unique([playerId, playStyleDefinitionId])
}

// ─── Items ──────────────────────────────────────────────
model ItemDefinition {
  id          String         @id @default(uuid())
  name        String         @unique
  description String?
  effectType  ItemEffectType
  effectValue Int
  price       Int
  isActive    Boolean        @default(true)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  teamItems TeamItem[]
  usageLogs ItemUsageLog[]
}

model TeamItem {
  id               String   @id @default(uuid())
  teamId           String
  itemDefinitionId String
  quantity         Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  team           Team           @relation(fields: [teamId], references: [id], onDelete: Cascade)
  itemDefinition ItemDefinition @relation(fields: [itemDefinitionId], references: [id], onDelete: Cascade)

  @@unique([teamId, itemDefinitionId])
}

model ItemUsageLog {
  id               String   @id @default(uuid())
  teamId           String
  itemDefinitionId String
  playerId         String
  previousValue    Int
  newValue         Int
  usedAt           DateTime @default(now())

  team           Team           @relation(fields: [teamId], references: [id])
  itemDefinition ItemDefinition @relation(fields: [itemDefinitionId], references: [id])
  player         Player         @relation(fields: [playerId], references: [id])
}

// ─── League Settings ────────────────────────────────────
model LeagueSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Trade Offers ───────────────────────────────────────
model TradeOffer {
  id                String           @id @default(uuid())
  initiatingTeamId  String
  receivingTeamId   String
  currencyOffered   Int              @default(0)
  currencyRequested Int              @default(0)
  status            TradeOfferStatus @default(PENDING)
  parentOfferId     String?
  note              String?
  responseNote      String?
  adminNote         String?
  expiresAt         DateTime?
  respondedAt       DateTime?
  approvedById      String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  initiatingTeam TradeOffer?        @relation("CounterOffers", fields: [parentOfferId], references: [id])
  counterOffers  TradeOffer[]       @relation("CounterOffers")
  initTeam       Team               @relation("InitiatingTeam", fields: [initiatingTeamId], references: [id])
  recvTeam       Team               @relation("ReceivingTeam", fields: [receivingTeamId], references: [id])
  approvedBy     User?              @relation("ApprovedBy", fields: [approvedById], references: [id])
  offeredPlayers TradeOfferPlayer[] @relation("OfferedIn")
  requestedPlayers TradeOfferPlayer[] @relation("RequestedIn")
  transactions   Transaction[]

  @@index([status])
}

model TradeOfferPlayer {
  id            String  @id @default(uuid())
  playerId      String
  offeredInId   String?
  requestedInId String?

  player      Player      @relation(fields: [playerId], references: [id])
  offeredIn   TradeOffer? @relation("OfferedIn", fields: [offeredInId], references: [id], onDelete: Cascade)
  requestedIn TradeOffer? @relation("RequestedIn", fields: [requestedInId], references: [id], onDelete: Cascade)

  @@unique([playerId, offeredInId])
  @@unique([playerId, requestedInId])
}

// ─── Waiver Wire ────────────────────────────────────────
model WaiverWire {
  id               String       @id @default(uuid())
  playerId         String
  releasedFromId   String?
  status           WaiverStatus @default(ACTIVE)
  waiverPeriodDays Int
  expiresAt        DateTime
  winningBidId     String?      @unique
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt

  player       Player     @relation(fields: [playerId], references: [id])
  releasedFrom Team?      @relation(fields: [releasedFromId], references: [id])
  winningBid   WaiverBid? @relation("WinningBid", fields: [winningBidId], references: [id])
  bids         WaiverBid[] @relation("WaiverBids")
  transactions Transaction[]
}

model WaiverBid {
  id           String   @id @default(uuid())
  waiverWireId String
  teamId       String
  amount       Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  waiverWire  WaiverWire  @relation("WaiverBids", fields: [waiverWireId], references: [id], onDelete: Cascade)
  team        Team        @relation(fields: [teamId], references: [id])
  wonWaiver   WaiverWire? @relation("WinningBid")

  @@unique([waiverWireId, teamId])
}

// ─── Transaction Log ────────────────────────────────────
model Transaction {
  id             String          @id @default(uuid())
  type           TransactionType
  playerId       String
  fromTeamId     String?
  toTeamId       String?
  currencyAmount Int?
  tradeOfferId   String?
  waiverWireId   String?
  note           String?
  executedById   String?
  createdAt      DateTime        @default(now())

  player     Player      @relation(fields: [playerId], references: [id])
  fromTeam   Team?       @relation("FromTeam", fields: [fromTeamId], references: [id])
  toTeam     Team?       @relation("ToTeam", fields: [toTeamId], references: [id])
  tradeOffer TradeOffer? @relation(fields: [tradeOfferId], references: [id])
  waiverWire WaiverWire? @relation(fields: [waiverWireId], references: [id])
  executedBy User?       @relation("ExecutedBy", fields: [executedById], references: [id])
}
